###############################################################################
#                                                                             #
# IAR ANSI C/C++ Compiler V6.50.3.4676/W32 for ARM      14/Jul/2017  11:55:09 #
# Copyright 1999-2013 IAR Systems AB.                                         #
#                                                                             #
#    Cpu mode     =  thumb                                                    #
#    Endian       =  little                                                   #
#    Source file  =  C:\Users\Marcos\Dropbox\Reps\Dextro\IBA\Hardware\MaisPip #
#                    ocaG2\SOFTWARE\Drivers\Pagamentos\supervisao_mdb_cashles #
#                    s.c                                                      #
#    Command line =  C:\Users\Marcos\Dropbox\Reps\Dextro\IBA\Hardware\MaisPip #
#                    ocaG2\SOFTWARE\Drivers\Pagamentos\supervisao_mdb_cashles #
#                    s.c -lC C:\Users\Marcos\Dropbox\Reps\Dextro\IBA\Hardware #
#                    \MaisPipocaG2\SOFTWARE\Debug\List\ -lA                   #
#                    C:\Users\Marcos\Dropbox\Reps\Dextro\IBA\Hardware\MaisPip #
#                    ocaG2\SOFTWARE\Debug\List\ -o                            #
#                    C:\Users\Marcos\Dropbox\Reps\Dextro\IBA\Hardware\MaisPip #
#                    ocaG2\SOFTWARE\Debug\Obj\ --no_cse --no_unroll           #
#                    --no_inline --no_code_motion --no_tbaa --no_clustering   #
#                    --no_scheduling --debug --endian=little --cpu=Cortex-M3  #
#                    -e --fpu=None --dlib_config "C:\Program Files (x86)\IAR  #
#                    Systems\Embedded Workbench 6.5\arm\INC\c\DLib_Config_Nor #
#                    mal.h" -Ol                                               #
#    List file    =  C:\Users\Marcos\Dropbox\Reps\Dextro\IBA\Hardware\MaisPip #
#                    ocaG2\SOFTWARE\Debug\List\supervisao_mdb_cashless.lst    #
#    Object file  =  C:\Users\Marcos\Dropbox\Reps\Dextro\IBA\Hardware\MaisPip #
#                    ocaG2\SOFTWARE\Debug\Obj\supervisao_mdb_cashless.o       #
#                                                                             #
#                                                                             #
###############################################################################

C:\Users\Marcos\Dropbox\Reps\Dextro\IBA\Hardware\MaisPipocaG2\SOFTWARE\Drivers\Pagamentos\supervisao_mdb_cashless.c
      1          /*__________________________________________________________________________________
      2          |	Quark Tecnologia Eletrônica Embarcada
      3          |       
      4          |       Itapema - SC
      5          |       www.quarktee.com.br
      6          | __________________________________________________________________________________
      7          |
      8          |       This source code was developed by Quark  and cannot be copied, in part 
      9          |       or in whole, or used, except when legally licensed by Quark 
     10          |       or its distributors.
     11          |
     12          |       Este código é propriedade da Quark  e não pode ser copiado, em parte 
     13          |       ou em todo, ou utilizado, exceto quando for legalmente licenciado pela 
     14          |       Quark  ou por um de seus distribuidores.
     15          | __________________________________________________________________________________
     16          |
     17          |       Arquivo            :  supervisao_mdb_cashless.c
     18          |       Descrição          :  Máquina de estados que gerencia o meio de pagamento
     19          |                             MDB BILL
     20          | 
     21          |       Autor              :  Marcos Aquino
     22          |       Data criação       :  13/06/2017
     23          |
     24          |       Revisões           :  1.0.0.0
     25          |
     26          |
     27          | __________________________________________________________________________________
     28          */
     29          
     30          /***********************************************************************************
     31          *       Includes
     32          ***********************************************************************************/
     33          #include <stdio.h>
     34          #include <stdlib.h>
     35          #include <string.h>
     36          #include "..\..\includes.h"
     37          #include "supervisao_mdb_cashless.h"
     38          
     39          /***********************************************************************************
     40          *       Definições
     41          ***********************************************************************************/
     42          #define TEMPO_INICILIZACAO_CASHLESS                     60000
     43          #define TENTATIVAS_CASHLESS                             10
     44          #define TEMPO_BUSCA_OFFLINE                             1000
     45          
     46          /***********************************************************************************
     47          *       Constantes locais
     48          ***********************************************************************************/
     49          
     50          
     51          /***********************************************************************************
     52          *       Variaveis locais
     53          ***********************************************************************************/

   \                                 In section .bss, align 4
     54          unsigned int SMC_contador;
   \                     SMC_contador:
   \   00000000                      DS8 4

   \                                 In section .bss, align 1
     55          unsigned char SMC_ciclos;
   \                     SMC_ciclos:
   \   00000000                      DS8 1

   \                                 In section .bss, align 1
     56          eCASHLESS_state SMC_estado_atual = CASHLESS_STATE_DESABILITADO;
   \                     SMC_estado_atual:
   \   00000000                      DS8 1
     57          
     58          /***********************************************************************************
     59          *       Funções locais
     60          ***********************************************************************************/
     61          eCASHLESS_state SMC_desabilitado(void);
     62          eCASHLESS_state SMC_setup(void);
     63          eCASHLESS_state SMC_offline_state(void);
     64          eCASHLESS_state SMC_poll_interface(void);
     65          eCASHLESS_state SMC_dispositivo_bloqueado(void);
     66          eCASHLESS_state SMC_inicia_transacao(void);
     67          eCASHLESS_state SMC_transacao_aprovada(void);
     68          eCASHLESS_state SMC_sucesso_transacao(void);
     69          
     70          /***********************************************************************************
     71          *       Tabela de funções
     72          ***********************************************************************************/

   \                                 In section .rodata, align 4
     73          eCASHLESS_state(*const MDBCASHLESS_funcs[])(void)={
   \                     MDBCASHLESS_funcs:
   \   00000000   0x00000000         DC32 0H, 0H, 0H, 0H, 0H, 0H, 0H, 0H, 0H
   \              0x00000000   
   \              0x00000000   
   \              0x00000000   
   \              0x00000000   
   \              0x00000000   
   \              0x00000000   
   \              0x00000000   
   \              0x00000000   
     74            [CASHLESS_STATE_DESABILITADO]    = NULL,
     75            [CASHLESS_STATE_SETUP]           = NULL,
     76            [CASHLESS_STATE_OFFLINE]         = NULL,
     77            [CASHLESS_STATE_POLL]            = NULL,
     78            [CASHLESS_STATE_LOCKED]          = NULL,
     79            [CASHLESS_STATE_INIT_VEND]       = NULL,
     80            [CASHLESS_STATE_VEND_APPROVED]   = NULL,
     81            [CASHLESS_STATE_VEND_SUCCESS]    = NULL,
     82            [CASHLESS_STATE_SESSION_COMPLET] = NULL
     83          };
     84            
     85          /***********************************************************************************
     86          *       Implementação das funções
     87          ***********************************************************************************/
     88          
     89          /***********************************************************************************
     90          *       Descrição       :       Inicialização do módulo
     91          *       Parametros      :       nenhum
     92          *       Retorno         :       nenhum
     93          ***********************************************************************************/

   \                                 In section .text, align 2, keep-with-next
     94          void SMC_ini(void){
     95            
     96            
     97            
     98          }
   \                     SMC_ini:
   \   00000000   0x4770             BX       LR               ;; return
     99          /***********************************************************************************
    100          *       Descrição       :       Tick da máquina de estados de supervisão
    101          *                               do cashless MDB
    102          *       Parametros      :       nenhum
    103          *       Retorno         :       nenhum
    104          ***********************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    105          void SMC_tick(void){
   \                     SMC_tick:
   \   00000000   0xB580             PUSH     {R7,LR}
    106          
    107            SMC_estado_atual = MDBCASHLESS_funcs[SMC_estado_atual]();        
   \   00000002   0x....             LDR.N    R0,??DataTable0
   \   00000004   0x7800             LDRB     R0,[R0, #+0]
   \   00000006   0x....             LDR.N    R1,??DataTable0_1
   \   00000008   0xF851 0x0020      LDR      R0,[R1, R0, LSL #+2]
   \   0000000C   0x4780             BLX      R0
   \   0000000E   0x....             LDR.N    R1,??DataTable0
   \   00000010   0x7008             STRB     R0,[R1, #+0]
    108          }
   \   00000012   0xBD01             POP      {R0,PC}          ;; return
    109          /***********************************************************************************
    110          *       Descrição       :       Estado onde o cashless está desabilitado
    111          *       Parametros      :       nenhum
    112          *       Retorno         :       eCASHLESS_state
    113          ***********************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    114          eCASHLESS_state SMC_desabilitado(void){
   \                     SMC_desabilitado:
   \   00000000   0xB580             PUSH     {R7,LR}
    115            unsigned char flag;
    116            
    117            PARAMETROS_le(ADR_FLAG_MDB_CASHLESS,(void*)&flag);
   \   00000002   0xA900             ADD      R1,SP,#+0
   \   00000004   0x2006             MOVS     R0,#+6
   \   00000006   0x.... 0x....      BL       PARAMETROS_le
    118            if(flag)
   \   0000000A   0xF89D 0x0000      LDRB     R0,[SP, #+0]
   \   0000000E   0x2800             CMP      R0,#+0
   \   00000010   0xD001             BEQ.N    ??SMC_desabilitado_0
    119              return CASHLESS_STATE_SETUP;      
   \   00000012   0x2001             MOVS     R0,#+1
   \   00000014   0xE000             B.N      ??SMC_desabilitado_1
    120            
    121            return CASHLESS_STATE_DESABILITADO;
   \                     ??SMC_desabilitado_0:
   \   00000016   0x2000             MOVS     R0,#+0
   \                     ??SMC_desabilitado_1:
   \   00000018   0xBD02             POP      {R1,PC}          ;; return
    122          }
    123          /***********************************************************************************
    124          *       Descrição       :       Estado em que realiza a configuração da
    125          *                               interface de cartão
    126          *       Parametros      :       nenhum
    127          *       Retorno         :       eCASHLESS_state
    128          ***********************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    129          eCASHLESS_state SMC_setup(void){
    130            /*
    131            unsigned char nivel_configurado;
    132            unsigned short int pais;
    133            unsigned char escala;
    134            unsigned char casas_decimais;
    135            unsigned char tempo_maximo_transacao;
    136            unsigned char opcoes_gerais;
    137            
    138            if(CASHLESS_set_and_get_setup_from_to_device(1,2,16,
    139                                                         ASCII,
    140                                                         &nivel_configurado,
    141                                                         &pais,
    142                                                         &escala,
    143            */
    144                                                         
    145            /*
    146          eMDB_reply CASHLESS_set_and_get_setup_from_to_device(unsigned char nivel_mdb,
    147                                                               unsigned char linhas_lcd,
    148                                                               unsigned char colunas_lcd,
    149                                                               eMDB_DISPLAY_INFO info_lcd,                                                     
    150                                                               unsigned char *nivel_configurado,
    151                                                               unsigned short int*pais,
    152                                                               unsigned char *escala,
    153                                                               unsigned char *casas_decimais,
    154                                                               unsigned char *tempo_maximo_transacao,
    155                                                               unsigned char *opcoes_gerais)  
    156            */
    157            return CASHLESS_STATE_SETUP;  
   \                     SMC_setup:
   \   00000000   0x2001             MOVS     R0,#+1
   \   00000002   0x4770             BX       LR               ;; return
    158          }
    159          /***********************************************************************************
    160          *       Descrição       :       Estado em que a interface está offline
    161          *       Parametros      :       nenhum
    162          *       Retorno         :       eCASHLESS_state
    163          ***********************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    164          eCASHLESS_state SMC_offline_state(void){
    165          
    166            
    167            return CASHLESS_STATE_OFFLINE;
   \                     SMC_offline_state:
   \   00000000   0x2002             MOVS     R0,#+2
   \   00000002   0x4770             BX       LR               ;; return
    168          }
    169          /***********************************************************************************
    170          *       Descrição       :       Estado em que é realizado o poll do
    171          *                               dispositivo
    172          *       Parametros      :       nenhum
    173          *       Retorno         :       eCASHLESS_state
    174          ***********************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    175          eCASHLESS_state SMC_poll_interface(void){
    176          
    177            
    178            return  CASHLESS_STATE_POLL;
   \                     SMC_poll_interface:
   \   00000000   0x2003             MOVS     R0,#+3
   \   00000002   0x4770             BX       LR               ;; return
    179          }
    180          /***********************************************************************************
    181          *       Descrição       :       Estado no qual o dispositivo está bloqueado
    182          *       Parametros      :       nenhum
    183          *       Retorno         :       eCASHLESS_state
    184          ***********************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    185          eCASHLESS_state SMC_dispositivo_bloqueado(void){
    186          
    187            
    188            return  CASHLESS_STATE_LOCKED;
   \                     SMC_dispositivo_bloqueado:
   \   00000000   0x2004             MOVS     R0,#+4
   \   00000002   0x4770             BX       LR               ;; return
    189          }
    190          /***********************************************************************************
    191          *       Descrição       :       Estado em que é iniciada a transação
    192          *                               de venda
    193          *       Parametros      :       nenhum
    194          *       Retorno         :       eCASHLESS_state
    195          ***********************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    196          eCASHLESS_state SMC_inicia_transacao(void){
    197          
    198            
    199            return CASHLESS_STATE_INIT_VEND;
   \                     SMC_inicia_transacao:
   \   00000000   0x2005             MOVS     R0,#+5
   \   00000002   0x4770             BX       LR               ;; return
    200          }
    201          /***********************************************************************************
    202          *       Descrição       :       Estado no qual a venda foi aprovada
    203          *       Parametros      :       nenhum
    204          *       Retorno         :       eCASHLESS_state
    205          ***********************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    206          eCASHLESS_state SMC_transacao_aprovada(void){
    207          
    208            
    209            return CASHLESS_STATE_VEND_APPROVED;
   \                     SMC_transacao_aprovada:
   \   00000000   0x2006             MOVS     R0,#+6
   \   00000002   0x4770             BX       LR               ;; return
    210          }
    211          /***********************************************************************************
    212          *       Descrição       :       Estado no qual recebeu a configuração
    213          *                               do crédito
    214          *       Parametros      :       nenhum
    215          *       Retorno         :       eCASHLESS_state 
    216          ***********************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    217          eCASHLESS_state SMC_sucesso_transacao(void){
    218            
    219            
    220            return CASHLESS_STATE_VEND_SUCCESS;
   \                     SMC_sucesso_transacao:
   \   00000000   0x2007             MOVS     R0,#+7
   \   00000002   0x4770             BX       LR               ;; return
    221          }
    222          /***********************************************************************************
    223          *       Descrição       :       Estado no qual a transação foi completada
    224          *       Parametros      :       nenhum
    225          *       Retorno         :       eCASHLESS_state
    226          ***********************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    227          eCASHLESS_state SMC_transacao_completada(void){
    228            
    229            
    230            return CASHLESS_STATE_SESSION_COMPLET;
   \                     SMC_transacao_completada:
   \   00000000   0x2008             MOVS     R0,#+8
   \   00000002   0x4770             BX       LR               ;; return
    231          }

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0:
   \   00000000   0x........         DC32     SMC_estado_atual

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0_1:
   \   00000000   0x........         DC32     MDBCASHLESS_funcs
    232          /***********************************************************************************
    233          *       Fim do arquivo
    234          ***********************************************************************************/

   Maximum stack usage in bytes:

   .cstack Function
   ------- --------
       8   SMC_desabilitado
         8   -> PARAMETROS_le
       0   SMC_dispositivo_bloqueado
       0   SMC_ini
       0   SMC_inicia_transacao
       0   SMC_offline_state
       0   SMC_poll_interface
       0   SMC_setup
       0   SMC_sucesso_transacao
       8   SMC_tick
         8   -- Indirect call
       0   SMC_transacao_aprovada
       0   SMC_transacao_completada


   Section sizes:

   Bytes  Function/Label
   -----  --------------
       4  ??DataTable0
       4  ??DataTable0_1
      36  MDBCASHLESS_funcs
       1  SMC_ciclos
       4  SMC_contador
      26  SMC_desabilitado
       4  SMC_dispositivo_bloqueado
       1  SMC_estado_atual
       2  SMC_ini
       4  SMC_inicia_transacao
       4  SMC_offline_state
       4  SMC_poll_interface
       4  SMC_setup
       4  SMC_sucesso_transacao
      20  SMC_tick
       4  SMC_transacao_aprovada
       4  SMC_transacao_completada

 
  6 bytes in section .bss
 36 bytes in section .rodata
 88 bytes in section .text
 
 88 bytes of CODE  memory
 36 bytes of CONST memory
  6 bytes of DATA  memory

Errors: none
Warnings: none
